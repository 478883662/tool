<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Home</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="robots" content="all,follow">
    <!-- Bootstrap CSS-->
    <script src="vendor/jquery/jquery-3.4.1.min.js" type="text/javascript"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js" type="text/javascript" ></script>
    <script src="js/getUrl.js" type="text/javascript" ></script>
</head>
<script>
    var ylCard = $.getUrlParam('ylCard');
    var name = $.getUrlParam('name');
    function upload() {
        if (!window.FormData) {
            $("#msg").html("你的浏览器不支持。");
            $(".alert").show();
        }
        //获得原生的form表单对象，等价于document.forms[0]
        var form = document.getElementById("uploadForm");
        //单个文件超过400MB就不再上传
        var hasError = false;
        $("input[type='file']", form).each(function (index, file) {
            if (file.files.length > 0) {
                if (file.files[0].size > 400 * 1024 * 1024) {
                    $("#msg").html("单个文件不能超过400MB。");
                    $(".alert").show();
                    hasError = true;
                    return;
                }
            }
        });
        if (hasError) {
            return;
        }
        //构造FormData对象用于发送数据
        var formData = new FormData(form);
        var xhr = new XMLHttpRequest();
        xhr.open("post", form.action+"?ylCard="+ylCard+"&name="+name, true);

        //设置请求超时
        xhr.upload.timeout = 2000;
        xhr.upload.ontimeout = function (event) {
            $("#msg").html("请求超时！");
            $(".alert").show();
        };
        //添加progress事件
        xhr.upload.addEventListener("progress", function (e) {
            $(".progress-bar").addClass("active");
            var howMuch = e.loaded / e.total;
            var p = parseFloat((howMuch * 100).toFixed(2)) + "%";
            $(".progress-bar").css("width", p).html(p);
        }, false);
        //上传完成
        xhr.upload.addEventListener("load", function (event) {
            $(".progress-bar").removeClass("active");
            alert("上传完成！");
            window.close();
        }, false);
        xhr.upload.addEventListener("error", function (event) {
            $(".progress-bar").removeClass("active");
            $("#msg").html("上传出错！");
            $(".alert").show();
        }, false);
        xhr.upload.addEventListener("abort", function (event) {
            $(".progress-bar").removeClass("active");
            $("#msg").html("您取消了本次上传。");
            $(".alert").show();
        }, false);
        xhr.send(formData);
    }

    //重置
    function test() {
        $("input[type='file']", document.forms[0]).each(function (index, file) {
            file.value = null;
        });
    }
</script>

<body>
<div class="panel panel-primary">
    <div class="panel-heading">
        <h3 class="panel-title">文件上传（仅支持png格式的图片）</h3>
    </div>
    <div class="panel-body">
        <div class="alert alert-danger alert-dismissable" style="display:none;">
            <button type="button" class="close" onclick="$('.alert').hide();"
                    aria-hidden="true">
                &times;
            </button>
            <span id="msg">
           错误！请进行一些更改。</span>
        </div>
        <form id="uploadForm" action="/reimbUser/upload" method="post" enctype="multipart/form-data">
            <div class="input-group">
                <span class="input-group-addon" id="basic-addon1">医疗账户图</span>
                <input name="file" type="file" class="form-control" aria-describedby="basic-addon1">
            </div>
            <p></p>
            <div class="progress">
                <div class="progress-bar progress-bar-danger progress-bar-striped active" role="progressbar"
                     aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                    0%
                </div>
            </div>
        </form>
        <div style="text-align: center;">
            <button type="button" onclick="upload()" class="btn btn-primary" autocomplete="off">
                上传
            </button>
            <button type="button" onclick="test()" class="btn btn-primary" autocomplete="off">
                重置
            </button>
        </div>
        <div>
            <img id="resultFile" src="">
        </div>
    </div>
</div>
</body>
</html>